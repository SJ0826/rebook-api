# .github/workflows/deploy.yml
name: Deploy to EC2

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Deploy to EC2
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem
          
          # SSH ì—°ê²° í…ŒìŠ¤íŠ¸
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSH connection test successful'"
          
          # ë°°í¬ ì‹¤í–‰
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e  # ì—ëŸ¬ ë°œìƒì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
          
            echo "ğŸš€ Starting deployment..."
          
            # Node.js 20 ì‚¬ìš© í™•ì¸
            source ~/.bashrc
            nvm use 20 || echo "Warning: nvm not available"
          
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/ubuntu/rebook-api
          
            # Node.js ë²„ì „ í™•ì¸
            echo "Node.js version: $(node --version)"
            echo "NPM version: $(npm --version)"
          
            # Gitì—ì„œ ìµœì‹  ì½”ë“œ pull
            git pull origin main
          
            # ì˜ì¡´ì„± ì„¤ì¹˜
            npm ci
          
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
            npm run build
          
            # PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘ (graceful reload ì‚¬ìš©)
            pm2 reload ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production
          
            # PM2 í”„ë¡œì„¸ìŠ¤ ìƒíƒœ í™•ì¸
            pm2 status
          
            echo "âœ… Deployment completed successfully!"
          EOF
          
          # SSH í‚¤ íŒŒì¼ ì •ë¦¬
          rm -f private_key.pem